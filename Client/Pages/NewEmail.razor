@page "/new-email"

@attribute [Authorize]


<RadzenRow>
    <RadzenColumn Size="12">
        <RadzenTemplateForm TItem="Server.Models.EmailMessage" Submit="@TemplateForm0Submit" Data="@emailMessage">
<RadzenStack>
            
            
            <RadzenFormField Text="Template" Variant="Variant.Outlined">
                  <ChildContent>
                      <RadzenDropDown TValue="int" ValueProperty="EmailTemplateId" TextProperty="Title" Data="@emailTemplates" LoadData="@emailTemplatesLoadData" Count="@emailTemplatesCount" @bind-Value="@emailMessage.TemplateId" Name="TemplateId" AllowFiltering="true" FilterCaseSensitivity="Radzen.FilterCaseSensitivity.CaseInsensitive" Change="@TemplateIdChange"/>
              </ChildContent>
              <Helper>
                    <RadzenRequiredValidator Component="TemplateId" Text="Template is required" />
                  </Helper>
            </RadzenFormField>
<RadzenFormField Text="From Email Address" Variant="Variant.Outlined">
                  <ChildContent>
                    <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(emailMessage.From)" Name="From" MaxLength="255" />
              </ChildContent>
              <Helper>
                    <RadzenRequiredValidator Component="From" Text="From is required" />
                  </Helper>
            </RadzenFormField>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Wrap="Radzen.FlexWrap.Wrap">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Visible="@(Ticket.item.contactID != null && string.IsNullOrEmpty(selectedTemplate?.TeamsChannelEmail))">
                    <RadzenCheckBox TValue="bool" @bind-Value="@ticketContact" Name="TicketContact"></RadzenCheckBox>
                    <RadzenLabel Text="Ticket Contact?" Component="TicketContact" />

                </RadzenStack>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Visible="true">
                    <RadzenCheckBox TValue="bool" @bind-Value="@ticketContacts" Name="TicketContacts"></RadzenCheckBox>
                    <RadzenLabel Text="All Ticket Contacts?" Component="TicketContacts" />

                </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Visible="@(Ticket.item.assignedResourceID != null && string.IsNullOrEmpty(selectedTemplate?.TeamsChannelEmail))">
                    <RadzenCheckBox TValue="bool" @bind-Value="@primaryResource" Name="PrimaryResource"></RadzenCheckBox>
                    <RadzenLabel Text="Primary Resource?" Component="PrimaryResource" />

                </RadzenStack>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Visible="true">
                        <RadzenCheckBox TValue="bool" @bind-Value="@secondaryResources" Name="SecondaryResources"></RadzenCheckBox>
                    <RadzenLabel Text="All Ticket Resources?" Component="SecondaryResources" />

                </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Visible="@(!string.IsNullOrEmpty(selectedTemplate?.TeamsChannelEmail))">
                        <RadzenCheckBox TValue="bool" @bind-Value="@msTeamsEmail" Change="@notifyMSTeamsChannelCheckBoxChange" Name="MsTeamsEmail"></RadzenCheckBox>
                        <RadzenLabel Text="Notify Teams Channel?" Component="MsTeamsEmail" />

                    </RadzenStack>
            </RadzenStack>
            <RadzenFieldset Text="Additional Emails" Icon="email" AllowCollapse="true" Collapsed="true" Visible="@(string.IsNullOrEmpty(selectedTemplate?.TeamsChannelEmail))">
                <RadzenStack>
                    <RadzenFormField Text="Additional Contacts" Variant="Variant.Outlined">
                          <ChildContent>
                              <RadzenDropDown TValue="IEnumerable<string>" @bind-Value="@contactEmails" Data="@contacts" ValueProperty="emailAddress" TextProperty="fullName" AllowFiltering="true" Multiple="true" FilterCaseSensitivity="Radzen.FilterCaseSensitivity.CaseInsensitive" >
                                  
                              </RadzenDropDown>
                      </ChildContent>
                      
                    </RadzenFormField>
                    <RadzenFormField Text="Additional Team Members" Variant="Variant.Outlined" Component="CrownTeam">
                              <ChildContent>
                                  <RadzenDropDown TValue="IEnumerable<string>" @bind-Value="@crownTeamEmails" ValueProperty="Email" TextProperty="FullName" Data="@resourceCaches" LoadData="@resourceCachesLoadData" Count="@resourceCachesCount" Multiple="true" Name="CrownTeam" AllowFiltering="true"/>
                          </ChildContent>
                          
                        </RadzenFormField>
                        <RadzenFormField Text="Separate Multiple Emails with Commas (email1,email2) | No Spaces" Variant="Variant.Outlined" Component="AdditionalEmail">
                          <ChildContent>
                              <RadzenTextBox @bind-Value="@additionalEmail" Name="additionalEmail"></RadzenTextBox>
                                  
                            </ChildContent>
                        </RadzenFormField>
                </RadzenStack>
            </RadzenFieldset>
            <RadzenFormField Text="Quote Link" Variant="Variant.Outlined" Visible="@quoteTemplate">
                  <ChildContent>
                    <RadzenTextBox style="display: block; width: 100%" @bind-Value="@emailMessage.QuoteLink" Name="QuoteLink" MaxLength="255" Change="@QuoteLinkChange" />
                  </ChildContent>    
                  <Helper>
                    <RadzenRequiredValidator Component="QuoteLink" Text="Quote Link is required" />
                  </Helper>
            </RadzenFormField>
<RadzenFormField Text="Email Subject" Variant="Variant.Outlined">
                  <ChildContent>
                    <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(emailMessage.Subject)" Name="Subject" MaxLength="255" />
                  </ChildContent>    
                  <Helper>
                    <RadzenRequiredValidator Component="Subject" Text="Subject is required" />
                  </Helper>
            </RadzenFormField>
            <RadzenSplitButton Variant="Radzen.Variant.Outlined" Size="Radzen.ButtonSize.Small" Icon="cognition_2" Click="@AIEmailBodySplitButtonClick" Text="AI Actions" Style="width: 255px" IsBusy="@emailAiBusy">
                @if (promptConfigurations.Where(x => x.TimeGuardSection.SectionName == "Time Entry Email").Any())
                    {
                        foreach(var item in promptConfigurations.Where(x => x.TimeGuardSection.SectionName == "Time Entry Email"))
                        {
                            <RadzenSplitButtonItem Text="@item.MenuName" Value="@item.AiPromptConfigurationId.ToString()" Icon="cognition_2"></RadzenSplitButtonItem>
                        }
                    }
                    
            </RadzenSplitButton>
            <RadzenFormField Text="Email Body" Variant="Variant.Outlined">
                  <ChildContent>
                      <RadzenHtmlEditor Name="Body" Style="min-height: 400px" UploadUrl="upload/image" @bind-Value="@emailMessage.Body"></RadzenHtmlEditor>
                  </ChildContent>    
                  <Helper>
                    <RadzenRequiredValidator Component="Body" Text="Body is required" />
                  </Helper>
            </RadzenFormField>
            
            <RadzenFieldset Text="Attachments" AllowCollapse="true" Icon="attachment">
                <RadzenStack Orientation="Radzen.Orientation.Vertical">
                    <RadzenUpload Url="upload/EmailAttachments" ChooseText="Choose Files to Attach or Drag & Drop Here" Multiple="true" Complete="@Upload0Complete" Error="@Upload0Error" Progress="@Upload0Progress" Style="width: 285px"></RadzenUpload>
                    <RadzenProgressBar Visible="@progressVisible" Mode="Radzen.ProgressBarMode.Determinate" ShowValue="true" ProgressBarStyle="Radzen.ProgressBarStyle.Info" Style="height: 30px" Value="100">
                        <Template>
                            <RadzenStack Style="width: 100%" AlignItems="Radzen.AlignItems.Center">
                                <RadzenLabel Text="Uploading..." />
                            </RadzenStack>
                        </Template>
                        
                    </RadzenProgressBar>
                    <RadzenDataGrid @ref="grid0" Data="@emailAttachments" TItem="Server.Models.EmailMessage.IFormFileModel" Density="Radzen.Density.Compact" IsLoading="@gridLoading">
                        <Columns>
                            <RadzenDataGridColumn TItem="Server.Models.EmailMessage.IFormFileModel" Property="FileName" Title="File Name"></RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Server.Models.EmailMessage.IFormFileModel" Frozen="true" FrozenPosition="Radzen.FrozenColumnPosition.Right" Width="80px">
                                <Template Context="data">
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Click="@((args) =>DeleteAttachmentButtonClick(args, data))">
                                    </RadzenButton>
                                  </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                        
                    </RadzenDataGrid>
                
                </RadzenStack>
            </RadzenFieldset>
          </RadzenStack>
          <RadzenStack style="margin-top:1rem;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" IsBusy="@sendingEmail" BusyText="Sending Email" Icon="send" Text="Send" Variant="Variant.Flat" />
                    <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Cancel" Variant="Variant.Flat" Click="@CancelButtonClick"  />
          </RadzenStack>
        </RadzenTemplateForm>
    </RadzenColumn>
</RadzenRow>
